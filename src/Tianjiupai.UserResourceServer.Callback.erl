-module('Tianjiupai.UserResourceServer.Callback').
-export(['init'/1, 'handle_call'/3, 'handle_cast'/2, 'handle_down'/4, 'handle_timeout'/1, 'handle_info'/2, 'terminate'/2]).
'init'(ok) -> begin S2546State = #{num_users => 0}, 'SesterlStdlib.GenServer':'init_ok'(S2546State) end.
'handle_call'(S2548Req, _, S2549State) -> begin {'add_user', S2550UserId, S2551UserName} = S2548Req, begin S2552NumUsers = maps:get(num_users, S2549State), case (S2552NumUsers >= 'Tianjiupai.Constants':'maximum_num_users'()) of true -> 'SesterlStdlib.GenServer':'reply'({'user_added', {'error', 'SesterlStdlib.RawValue':'forget'(<<"capacity exceeded"/utf8>>)}}, S2549State); false -> begin S2553Res = 'Tianjiupai.UserServerSup':'start_child'(S2550UserId, S2551UserName), case S2553Res of {'ok', S2554Proc} -> begin S2555Mref = 'SesterlStdlib.MonitorRef':'monitor'('Tianjiupai.UserServer':'as_pid'(S2554Proc)), begin _ = begin S3295 = 'Tianjiupai.Logger':'info'({"increment num_users ~p --> ~p (proc: ~p, mref: ~p)", 4}, {S2552NumUsers, (S2552NumUsers + 1), S2554Proc, S2555Mref}), S3295(<<"UserResourceServer.sest">>, 58) end, 'SesterlStdlib.GenServer':'reply'({'user_added', {'ok', S2554Proc}}, #{num_users => (S2552NumUsers + 1)}) end end; {'error', S2556Err} -> 'SesterlStdlib.GenServer':'reply'({'user_added', {'error', S2556Err}}, S2549State) end end end end end.
'handle_cast'(S2558Msg, S2559State) -> begin _ = begin S3297 = 'Tianjiupai.Logger':'warning'({"unexpected cast (message: ~p, state: ~p)", 2}, {S2558Msg, S2559State}), S3297(<<"UserResourceServer.sest">>, 69) end, 'SesterlStdlib.GenServer':'no_reply'(S2559State) end.
'handle_down'(S2561Mref, S2562Pid, S2563Reason, S2564State) -> begin S2565NumUsers = maps:get(num_users, S2564State), begin _ = begin S3299 = 'Tianjiupai.Logger':'info'({"decrement num_users ~p --> ~p (pid: ~p, mref: ~p, reason: ~p)", 5}, {S2565NumUsers, (S2565NumUsers - 1), S2562Pid, S2561Mref, S2563Reason}), S3299(<<"UserResourceServer.sest">>, 75) end, 'SesterlStdlib.GenServer':'no_reply'(#{num_users => (S2565NumUsers - 1)}) end end.
'handle_timeout'(S2567State) -> 'SesterlStdlib.GenServer':'no_reply'(S2567State).
'handle_info'(S2569Info, S2570State) -> begin _ = begin S3302 = 'Tianjiupai.Logger':'warning'({"unexpected info (info: ~p, state: ~p)", 2}, {S2569Info, S2570State}), S3302(<<"UserResourceServer.sest">>, 85) end, 'SesterlStdlib.GenServer':'no_reply'(S2570State) end.
'terminate'(S2572Reason, S2573State) -> begin _ = begin S3304 = 'Tianjiupai.Logger':'warning'({"terminate (reason: ~p, state: ~p)", 2}, {S2572Reason, S2573State}), S3304(<<"UserResourceServer.sest">>, 89) end, sesterl_internal_prim:'return'(ok) end.
