-module('Tianjiupai.UserResourceServer.Callback').
-export(['init'/1, 'handle_call'/3, 'handle_cast'/2, 'handle_down'/4, 'handle_timeout'/1, 'handle_info'/2, 'terminate'/2]).
'init'(ok) -> begin S2568State = #{num_users => 0}, 'SesterlStdlib.GenServer':'init_ok'(S2568State) end.
'handle_call'(S2570Req, _, S2571State) -> case S2570Req of {'add_user', S2572UserId, S2573UserName} -> begin S2574NumUsers = maps:get(num_users, S2571State), case (S2574NumUsers >= 'Tianjiupai.Constants':'maximum_num_users'()) of true -> 'SesterlStdlib.GenServer':'reply'({'user_added', {'error', 'SesterlStdlib.RawValue':'forget'(<<"capacity exceeded"/utf8>>)}}, S2571State); false -> begin S2575Res = 'Tianjiupai.UserServerSup':'start_child'(S2572UserId, S2573UserName), case S2575Res of {'ok', S2576Proc} -> begin S2577Mref = 'SesterlStdlib.MonitorRef':'monitor'('Tianjiupai.UserServer':'as_pid'(S2576Proc)), begin _ = begin S3409 = 'Tianjiupai.Logger':'info'({"increment num_users ~p --> ~p (proc: ~p, mref: ~p)", 4}, {S2574NumUsers, (S2574NumUsers + 1), S2576Proc, S2577Mref}), S3409(<<"UserResourceServer.sest">>, 61) end, 'SesterlStdlib.GenServer':'reply'({'user_added', {'ok', S2576Proc}}, #{num_users => (S2574NumUsers + 1)}) end end; {'error', S2578Err} -> 'SesterlStdlib.GenServer':'reply'({'user_added', {'error', S2578Err}}, S2571State) end end end end; 'get_num_users' -> 'SesterlStdlib.GenServer':'reply'({'num_users_got', maps:get(num_users, S2571State)}, S2571State) end.
'handle_cast'(S2580Msg, S2581State) -> begin _ = begin S3411 = 'Tianjiupai.Logger':'warning'({"unexpected cast (message: ~p, state: ~p)", 2}, {S2580Msg, S2581State}), S3411(<<"UserResourceServer.sest">>, 75) end, 'SesterlStdlib.GenServer':'no_reply'(S2581State) end.
'handle_down'(S2583Mref, S2584Pid, S2585Reason, S2586State) -> begin S2587NumUsers = maps:get(num_users, S2586State), begin _ = begin S3413 = 'Tianjiupai.Logger':'info'({"decrement num_users ~p --> ~p (pid: ~p, mref: ~p, reason: ~p)", 5}, {S2587NumUsers, (S2587NumUsers - 1), S2584Pid, S2583Mref, S2585Reason}), S3413(<<"UserResourceServer.sest">>, 81) end, 'SesterlStdlib.GenServer':'no_reply'(#{num_users => (S2587NumUsers - 1)}) end end.
'handle_timeout'(S2589State) -> 'SesterlStdlib.GenServer':'no_reply'(S2589State).
'handle_info'(S2591Info, S2592State) -> begin _ = begin S3416 = 'Tianjiupai.Logger':'warning'({"unexpected info (info: ~p, state: ~p)", 2}, {S2591Info, S2592State}), S3416(<<"UserResourceServer.sest">>, 91) end, 'SesterlStdlib.GenServer':'no_reply'(S2592State) end.
'terminate'(S2594Reason, S2595State) -> begin _ = begin S3418 = 'Tianjiupai.Logger':'warning'({"terminate (reason: ~p, state: ~p)", 2}, {S2594Reason, S2595State}), S3418(<<"UserResourceServer.sest">>, 95) end, sesterl_internal_prim:'return'(ok) end.
